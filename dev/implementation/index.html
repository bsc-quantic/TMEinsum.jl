<!DOCTYPE html>
<html lang="en"><head><meta charset="UTF-8"/><meta name="viewport" content="width=device-width, initial-scale=1.0"/><title>Implementations · OMEinsum.jl</title><meta name="title" content="Implementations · OMEinsum.jl"/><meta property="og:title" content="Implementations · OMEinsum.jl"/><meta property="twitter:title" content="Implementations · OMEinsum.jl"/><meta name="description" content="Documentation for OMEinsum.jl."/><meta property="og:description" content="Documentation for OMEinsum.jl."/><meta property="twitter:description" content="Documentation for OMEinsum.jl."/><script data-outdated-warner src="../assets/warner.js"></script><link href="https://cdnjs.cloudflare.com/ajax/libs/lato-font/3.0.0/css/lato-font.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/juliamono/0.050/juliamono.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/fontawesome.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/solid.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/brands.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.16.8/katex.min.css" rel="stylesheet" type="text/css"/><script>documenterBaseURL=".."</script><script src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.6/require.min.js" data-main="../assets/documenter.js"></script><script src="../search_index.js"></script><script src="../siteinfo.js"></script><script src="../../versions.js"></script><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../assets/themes/documenter-dark.css" data-theme-name="documenter-dark" data-theme-primary-dark/><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../assets/themes/documenter-light.css" data-theme-name="documenter-light" data-theme-primary/><script src="../assets/themeswap.js"></script></head><body><div id="documenter"><nav class="docs-sidebar"><div class="docs-package-name"><span class="docs-autofit"><a href="../">OMEinsum.jl</a></span></div><button class="docs-search-query input is-rounded is-small is-clickable my-2 mx-auto py-1 px-2" id="documenter-search-query">Search docs (Ctrl + /)</button><ul class="docs-menu"><li><a class="tocitem" href="../">Home</a></li><li><a class="tocitem" href="../parsing/">Parsing</a></li><li class="is-active"><a class="tocitem" href>Implementations</a><ul class="internal"><li><a class="tocitem" href="#Identity"><span>Identity</span></a></li><li><a class="tocitem" href="#Permutations"><span>Permutations</span></a></li><li><a class="tocitem" href="#Tr"><span>Tr</span></a></li><li><a class="tocitem" href="#Sum"><span>Sum</span></a></li><li><a class="tocitem" href="#Repeat"><span>Repeat</span></a></li><li><a class="tocitem" href="#Diag"><span>Diag</span></a></li><li><a class="tocitem" href="#Duplicate"><span>Duplicate</span></a></li><li><a class="tocitem" href="#SimpleBinaryRule"><span>SimpleBinaryRule</span></a></li><li><a class="tocitem" href="#Fallback"><span>Fallback</span></a></li><li><a class="tocitem" href="#Debugging"><span>Debugging</span></a></li></ul></li><li><a class="tocitem" href="../contractionorder/">Contraction order optimization</a></li><li><a class="tocitem" href="../extending/">Extending OMEinsum</a></li><li><a class="tocitem" href="../docstrings/">DocStrings</a></li></ul><div class="docs-version-selector field has-addons"><div class="control"><span class="docs-label button is-static is-size-7">Version</span></div><div class="docs-selector control is-expanded"><div class="select is-fullwidth is-size-7"><select id="documenter-version-selector"></select></div></div></div></nav><div class="docs-main"><header class="docs-navbar"><a class="docs-sidebar-button docs-navbar-link fa-solid fa-bars is-hidden-desktop" id="documenter-sidebar-button" href="#"></a><nav class="breadcrumb"><ul class="is-hidden-mobile"><li class="is-active"><a href>Implementations</a></li></ul><ul class="is-hidden-tablet"><li class="is-active"><a href>Implementations</a></li></ul></nav><div class="docs-right"><a class="docs-navbar-link" href="https://github.com/under-Peter/OMEinsum.jl/blob/master/docs/src/implementation.md#L" title="Edit source on GitHub"><span class="docs-icon fa-solid"></span></a><a class="docs-settings-button docs-navbar-link fa-solid fa-gear" id="documenter-settings-button" href="#" title="Settings"></a><a class="docs-article-toggle-button fa-solid fa-chevron-up" id="documenter-article-toggle-button" href="javascript:;" title="Collapse all docstrings"></a></div></header><article class="content" id="documenter-page"><h1 id="Implementations"><a class="docs-heading-anchor" href="#Implementations">Implementations</a><a id="Implementations-1"></a><a class="docs-heading-anchor-permalink" href="#Implementations" title="Permalink"></a></h1><h2 id="Identity"><a class="docs-heading-anchor" href="#Identity">Identity</a><a id="Identity-1"></a><a class="docs-heading-anchor-permalink" href="#Identity" title="Permalink"></a></h2><p>To test whether a specification <code>ixs,iy</code> is the identity, it is checked whether <code>ixs</code> is made up of <em>one</em> tuple of index-labels that is equal to <code>iy</code> <em>and</em> that all index-labels in <code>iy</code> are unique - the latter to distinguish identity from e.g. projection to the diagonal like <code>ein&quot;ii -&gt; ii&quot;</code>.</p><p>The identity operation simply returns the first (and only) tensor argument to <code>einsum</code>.</p><h2 id="Permutations"><a class="docs-heading-anchor" href="#Permutations">Permutations</a><a id="Permutations-1"></a><a class="docs-heading-anchor-permalink" href="#Permutations" title="Permalink"></a></h2><p>A specification <code>ixs,iy</code> is an index-permutation if <code>ixs</code> is a tuple containing one tuple of index-labels that are all unique and are a permutation of the labels in <code>iy</code>.</p><p>Index-permutation is implemented with <code>permutedims</code> and a permutation that&#39;s calculated at runtime.</p><h2 id="Tr"><a class="docs-heading-anchor" href="#Tr">Tr</a><a id="Tr-1"></a><a class="docs-heading-anchor-permalink" href="#Tr" title="Permalink"></a></h2><p>A specification <code>ixs, iy</code> is a trace if <code>iy</code> is empty and <code>ixs</code> contains one 2-tuple containing the same index-label twice.</p><p>A trace dispatches to the <code>LinearAlgebra.tr</code> although the result is wrapped in a 0-dimensional array for type stability since all <code>einsum</code> return <code>AbstractArray</code>s.</p><h2 id="Sum"><a class="docs-heading-anchor" href="#Sum">Sum</a><a id="Sum-1"></a><a class="docs-heading-anchor-permalink" href="#Sum" title="Permalink"></a></h2><p>A specification <code>ixs,iy</code> is a sum or a reduction over indices if all indices in <code>iy</code> are unique and contained in the only tuple in <code>ixs</code> that additionally contains unique labels (that are reduced over).</p><p>Index-reductions are implemented using <code>Base.sum</code> and <code>Base.dropdims</code> - the latter to remove the singleton-dimensions left over after summing over a dimension.</p><h2 id="Repeat"><a class="docs-heading-anchor" href="#Repeat">Repeat</a><a id="Repeat-1"></a><a class="docs-heading-anchor-permalink" href="#Repeat" title="Permalink"></a></h2><p>The inverse rule of <code>Sum</code>, e.g. <code>ij-&gt;lijk</code>.</p><h2 id="Diag"><a class="docs-heading-anchor" href="#Diag">Diag</a><a id="Diag-1"></a><a class="docs-heading-anchor-permalink" href="#Diag" title="Permalink"></a></h2><p>A unary operation that remove multi-edges from a tensor, e.g. <code>ijkj-&gt;ikj</code>.</p><h2 id="Duplicate"><a class="docs-heading-anchor" href="#Duplicate">Duplicate</a><a id="Duplicate-1"></a><a class="docs-heading-anchor-permalink" href="#Duplicate" title="Permalink"></a></h2><p>The inverse rule of <code>Diag</code>, e.g. <code>ikj-&gt;ijkj</code>.</p><h2 id="SimpleBinaryRule"><a class="docs-heading-anchor" href="#SimpleBinaryRule">SimpleBinaryRule</a><a id="SimpleBinaryRule-1"></a><a class="docs-heading-anchor-permalink" href="#SimpleBinaryRule" title="Permalink"></a></h2><p>The contraction between two tensors with the following restriction</p><ul><li>a tensor can not be simplified by unary rules, e.g. <code>iij,jk,ik</code> is not valid, the first index can be simplified to <code>ij</code> using the unary rule <code>iij-&gt;ij</code>.</li><li>no multi-edge</li></ul><p>A complete list of rules are</p><ul><li>ein&quot;,-&gt;&quot;</li><li>ein&quot;,k-&gt;k&quot;</li><li>ein&quot;i,-&gt;i&quot;</li><li>ein&quot;j,j-&gt;&quot;</li><li>ein&quot;i,k-&gt;ik&quot; and ein&quot;i,k-&gt;ki&quot;,</li><li>ein&quot;j,jk-&gt;k&quot; and ein&quot;j,kj-&gt;k&quot;</li><li>ein&quot;ji,j-&gt;i&quot; and ein&quot;ij,j-&gt;i&quot;</li><li>ein&quot;ji,jk-&gt;ik&quot; and its index permutations (within a tensor)</li><li>ein&quot;l,l-&gt;l&quot;</li><li>ein&quot;l,kl-&gt;kl&quot;</li><li>ein&quot;il,-&gt;il&quot;</li><li>ein&quot;jl,jl-&gt;&quot;</li><li>ein&quot;il,kl-&gt;ikl&quot; and ein&quot;il,kl-&gt;kil&quot;,</li><li>ein&quot;jl,jkl-&gt;kl&quot; and ein&quot;jl,kjl-&gt;kl&quot;</li><li>ein&quot;jil,jl-&gt;il&quot; and ein&quot;ijl,jl-&gt;il&quot;</li><li>ein&quot;jil,jkl-&gt;ikl&quot; and its index permutations (within a tensor, except the batch dimension)</li></ul><p>Here, the batch dimension always appears as the last dimension.</p><h2 id="Fallback"><a class="docs-heading-anchor" href="#Fallback">Fallback</a><a id="Fallback-1"></a><a class="docs-heading-anchor-permalink" href="#Fallback" title="Permalink"></a></h2><p>The fallback is called for any specification that does not satisfy the criteria outlined above.</p><p>The dispatch calls <code>loop_einsum</code> which is defined in <code>loop_einsum.jl</code>.</p><p><code>loop_einsum</code> is based on the <code>EinArray</code>-struct. An <code>EinArray</code> is a subtype of <code>AbstractArray</code> that represents an intermediate step in a general einsum-expression <em>before</em> reductions remove indices. Consider a specification <code>ixs,iy</code> - the <code>EinArray</code> for that specification is the array with an index for each (distinct) label in <code>ixs</code> and <code>iy</code>. As an example, in <code>ein&quot;ij,ik,il -&gt; jkl&quot;(a,b,c)</code>, the distinct labels are <code>(i,j,k,l)</code> and the corresponding <code>EinArray</code> <code>einarr</code> would be a rank-4 tensor with an index each for each distinct label.</p><p>If an entry of <code>einarr</code> is requested, e.g. <code>einarr[i₁,j₁,k₁,l₁]</code>, it&#39;s values is lazily constructed as <code>einarr[i₁,j₁,k₁,l₁] = a[i₁,j₁]*a[i₁,k₁]*a[i₁,l₁]</code> upon access - the lazy evaluation avoids constructing the whole array.</p><p>To get to the final result, we reduce over the dimensions that are missing in the output. By first allocating an array of the correct size, we can fill it up with the entries of the <code>EinArray</code> which are calculated on the fly, avoiding the allocation of the intermediate result.</p><p>Thus effectively we split an operation like <code>ein&quot;ij,ik,il -&gt; jkl&quot;(a,b,c)</code> into two piece: <code>einarr = ein&quot;ij,ik,il -&gt; ijkl&quot;(a,b,c)</code> and <code>ein&quot;ijkl -&gt; jkl&quot;(einarr)</code> but treat the first operation as a lazy one - this way we can use <code>mapreduce(identity, +)</code> over the dimensions we want to remove which is implemented efficiently for both regular <code>Array</code>s and <code>CuArray</code>s.</p><h2 id="Debugging"><a class="docs-heading-anchor" href="#Debugging">Debugging</a><a id="Debugging-1"></a><a class="docs-heading-anchor-permalink" href="#Debugging" title="Permalink"></a></h2><p>Calling <code>allow_loops(false)</code> will cause an error to be printed when if the  fallback <code>loop_einsum</code> is used. This is an <code>@error</code> which does not interrupt execution. </p><p>Alternatively, a log of all methods used can be saved using <code>@debug</code> logging macro.  This is switched off by default, but can be printed by setting <code>ENV[&quot;JULIA_DEBUG&quot;] = &quot;all&quot;</code>.</p></article><nav class="docs-footer"><a class="docs-footer-prevpage" href="../parsing/">« Parsing</a><a class="docs-footer-nextpage" href="../contractionorder/">Contraction order optimization »</a><div class="flexbox-break"></div><p class="footer-message">Powered by <a href="https://github.com/JuliaDocs/Documenter.jl">Documenter.jl</a> and the <a href="https://julialang.org/">Julia Programming Language</a>.</p></nav></div><div class="modal" id="documenter-settings"><div class="modal-background"></div><div class="modal-card"><header class="modal-card-head"><p class="modal-card-title">Settings</p><button class="delete"></button></header><section class="modal-card-body"><p><label class="label">Theme</label><div class="select"><select id="documenter-themepicker"><option value="documenter-light">documenter-light</option><option value="documenter-dark">documenter-dark</option><option value="auto">Automatic (OS)</option></select></div></p><hr/><p>This document was generated with <a href="https://github.com/JuliaDocs/Documenter.jl">Documenter.jl</a> version 1.2.1 on <span class="colophon-date" title="Tuesday 27 February 2024 12:37">Tuesday 27 February 2024</span>. Using Julia version 1.10.1.</p></section><footer class="modal-card-foot"></footer></div></div></div></body></html>
