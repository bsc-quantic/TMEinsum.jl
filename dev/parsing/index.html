<!DOCTYPE html>
<html lang="en"><head><meta charset="UTF-8"/><meta name="viewport" content="width=device-width, initial-scale=1.0"/><title>Parsing · OMEinsum.jl</title><script data-outdated-warner src="../assets/warner.js"></script><link href="https://cdnjs.cloudflare.com/ajax/libs/lato-font/3.0.0/css/lato-font.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/juliamono/0.044/juliamono.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.3/css/fontawesome.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.3/css/solid.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.3/css/brands.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.13.11/katex.min.css" rel="stylesheet" type="text/css"/><script>documenterBaseURL=".."</script><script src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.6/require.min.js" data-main="../assets/documenter.js"></script><script src="../siteinfo.js"></script><script src="../../versions.js"></script><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../assets/themes/documenter-dark.css" data-theme-name="documenter-dark" data-theme-primary-dark/><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../assets/themes/documenter-light.css" data-theme-name="documenter-light" data-theme-primary/><script src="../assets/themeswap.js"></script></head><body><div id="documenter"><nav class="docs-sidebar"><div class="docs-package-name"><span class="docs-autofit"><a href="../">OMEinsum.jl</a></span></div><form class="docs-search" action="../search/"><input class="docs-search-query" id="documenter-search-query" name="q" type="text" placeholder="Search docs"/></form><ul class="docs-menu"><li><a class="tocitem" href="../">Home</a></li><li class="is-active"><a class="tocitem" href>Parsing</a><ul class="internal"><li class="toplevel"><a class="tocitem" href="#Input-(Nested)"><span>Input (Nested)</span></a></li></ul></li><li><a class="tocitem" href="../implementation/">Implementations</a></li><li><a class="tocitem" href="../contractionorder/">Contraction order optimization</a></li><li><a class="tocitem" href="../extending/">Extending OMEinsum</a></li><li><a class="tocitem" href="../docstrings/">DocStrings</a></li></ul><div class="docs-version-selector field has-addons"><div class="control"><span class="docs-label button is-static is-size-7">Version</span></div><div class="docs-selector control is-expanded"><div class="select is-fullwidth is-size-7"><select id="documenter-version-selector"></select></div></div></div></nav><div class="docs-main"><header class="docs-navbar"><nav class="breadcrumb"><ul class="is-hidden-mobile"><li class="is-active"><a href>Parsing</a></li></ul><ul class="is-hidden-tablet"><li class="is-active"><a href>Parsing</a></li></ul></nav><div class="docs-right"><a class="docs-edit-link" href="https://github.com/under-Peter/OMEinsum.jl/blob/master/docs/src/parsing.md#L" title="Edit on GitHub"><span class="docs-icon fab"></span><span class="docs-label is-hidden-touch">Edit on GitHub</span></a><a class="docs-settings-button fas fa-cog" id="documenter-settings-button" href="#" title="Settings"></a><a class="docs-sidebar-button fa fa-bars is-hidden-desktop" id="documenter-sidebar-button" href="#"></a></div></header><article class="content" id="documenter-page"><h1 id="Input-(flat)"><a class="docs-heading-anchor" href="#Input-(flat)">Input (flat)</a><a id="Input-(flat)-1"></a><a class="docs-heading-anchor-permalink" href="#Input-(flat)" title="Permalink"></a></h1><p>An einsum specification should be given via the <code>ein_str</code> string-literal or with the <code>@ein</code>-macro as e.g.</p><pre><code class="language-julia hljs">using OMEinsum
a, b = randn(2, 2), randn(2, 2)

c = ein&quot;ij,jk -&gt; ik&quot;(a,b)
@ein c[i,k] := a[i,j] * b[j,k]</code></pre><pre class="documenter-example-output"><code class="nohighlight hljs ansi">2×2 Matrix{Float64}:
 0.329157  -2.23066
 0.587876   3.53163</code></pre><p>where both specifications encode the same operation - a matrix multiplication. The <code>ein_str</code>-literal is parsed directly into an <code>EinCode</code> struct that holds the indices of the input <code>ixs = ((&#39;i&#39;,&#39;j&#39;),(&#39;j&#39;,&#39;k&#39;))</code> and output <code>iy = (&#39;i&#39;,&#39;k&#39;)</code> as type parameters, making them accessible at compile time.</p><p>The string-literal form gets turned into</p><pre><code class="language-julia hljs">c = EinCode(((&#39;i&#39;,&#39;j&#39;),(&#39;j&#39;,&#39;k&#39;)),(&#39;i&#39;,&#39;k&#39;))(a,b)</code></pre><pre class="documenter-example-output"><code class="nohighlight hljs ansi">2×2 Matrix{Float64}:
 0.329157  -2.23066
 0.587876   3.53163</code></pre><p>Calling an <code>EinCode</code>-object gets lowered to</p><pre><code class="language-julia hljs">c = einsum(EinCode(((&#39;i&#39;,&#39;j&#39;),(&#39;j&#39;,&#39;k&#39;)),(&#39;i&#39;,&#39;k&#39;)), (a,b), Dict(&#39;i&#39;=&gt;2, &#39;j&#39;=&gt;2, &#39;k&#39;=&gt;2))</code></pre><pre class="documenter-example-output"><code class="nohighlight hljs ansi">2×2 Matrix{Float64}:
 0.329157  -2.23066
 0.587876   3.53163</code></pre><p>The third argument <code>size_dict</code> is a dictionary to specify the dimensions of degree of freedoms, which could also allow to provide dimensions for index-labels that only appear in the output.</p><p>In the next step, a singleton-subtype of the abstract type <code>EinRule</code> is chosen which is later used for dispatch. Subtypes of <code>EinRule</code> specify the kind of operation and are created in such a way that they allow useful dispatch. They are defined in <code>EinRule.jl</code>.</p><p>The possible types are:</p><ul><li><code>Identity</code> - operation is the identity on <em>one</em> tensor, e.g. <code>ein&quot;ijk -&gt; ijk&quot;</code></li><li><code>Permutedims</code> - operation is a permutation of the indices of <em>one</em> tensor, e.g. <code>ein&quot;ijk -&gt; jki&quot;</code></li><li><code>Tr</code> - operation is a trace of <em>one</em> matrix, e.g. <code>ein&quot;ii -&gt;&quot;</code></li><li><code>Sum</code> - operation is a reduction over one or more indices of <em>one</em> tensor, e.g. <code>ein&quot;ijkl -&gt; il&quot;</code></li><li><code>SimpleBinaryRule</code> - operation is a pairwise contraction that can not be reduce by unary operations, e.g. <code>ein&quot;ijl,jkl-&gt; ikl&quot;</code></li><li><code>DefaultRule</code> - default if none of the above match, e.g. <code>ein&quot;ij,ik,il -&gt; jkl&quot;</code></li></ul><p>Since <code>ixs</code> and <code>iy</code> are saved as type-parameters, the operation-matching can happen at compile time. The operation is chosen using <code>match_rule(ixs,iy)</code> by testing all subtypes of <code>EinRule</code> in the sequence above (top to bottom) and picking the first match.</p><p>This enables us to chose fast BLAS functions for a  matrix multiplication which is also a legal tensor-contraction.</p><p>We proceed by calling <code>einsum(&lt;:EinRule, &lt;:EinCode, xs, size_dict)</code> which dispatches on the <code>EinRule</code> and the type of <code>xs</code> - the latter enables us to dispatch to e.g. cuda-specific routines for certain operations (as done in the <code>cueinsum.jl</code> file).</p><p>In the case of the matrix-multiplication above, <code>einsum</code> calls <code>*</code> which can dispatch to efficient routines for most <code>Array</code>-types including <code>CuArray</code>.</p><h1 id="Input-(Nested)"><a class="docs-heading-anchor" href="#Input-(Nested)">Input (Nested)</a><a id="Input-(Nested)-1"></a><a class="docs-heading-anchor-permalink" href="#Input-(Nested)" title="Permalink"></a></h1><p>Whether with the <code>ein_str</code> string-literal or the <code>@ein</code> macro, nested expressions are mapped to a nested struct. Consider the example</p><pre><code class="language-julia hljs">c = ein&quot;(ij,jk),kl -&gt; il&quot;(a,b,c)
@ein c[i,l] := (a[i,j] * b[j,k]) * c[k,l]</code></pre><pre class="documenter-example-output"><code class="nohighlight hljs ansi">2×2 Matrix{Float64}:
 -5.45883  -27.7312
  7.30838   34.3538</code></pre><p>which is a simply a product of three matrices evaluated as two matrix products in sequence.</p><p>This is equivalent to</p><pre><code class="language-julia hljs">c = ein&quot;ik,kl -&gt; il&quot;(ein&quot;ij,jk -&gt; ik&quot;(a,b),c)
@ein ab[i,k] := a[i,j] * b[j,k]
@ein c[i,l] := ab[i,k] * c[k,l]</code></pre><pre class="documenter-example-output"><code class="nohighlight hljs ansi">2×2 Matrix{Float64}:
 -56.3735  -262.498
  69.1795   320.484</code></pre><p>and is expressed as a nested structure <code>NestedEinsum</code> which contains the <code>EinCode</code>s for the intermediate calculations as well as some logic to assign the correct input and output tensors to the correct <code>EinCode</code>.</p><p><code>NestedEinsum</code> has the following definition:</p><pre><code class="language-julia hljs">struct NestedEinsum
    args
    eins
end</code></pre><p><code>args</code> holds the arguments to that <code>EinCode</code> which can either be a integer to label a tensor or a <code>NestedEinsum</code> itself. The labeling works such that the <code>i</code>th input is represented by the number <code>i</code>.</p><p>Upon application to tensors, a <code>NestedEinsum</code> evaluates its arguments. If the argument is an integer <code>i</code>, the <code>i</code>th provided tensor is chosen, otherwise the <code>NestedEinsum</code> is evaluated.</p><p>To make it more concrete, consider the <code>NestedEinsum</code> for the expression above, where for easier reading the type signatures were removed and the <code>EinCode</code>-structs were replaced by <code>ein</code>-string literals.</p><pre><code class="language-julia hljs">ein&quot;(ij,jk),kl -&gt; il&quot;</code></pre><pre class="documenter-example-output"><code class="nohighlight hljs ansi">ik, kl -&gt; il
├─ ij, jk -&gt; ik
│  ├─ ij
│  └─ jk
└─ kl
</code></pre><p>Evaluating this expression with three arguments leads to the inner <code>NestedEinsum</code> to be evaluated first with the first and second argument and the specifiation <code>ein&quot;ij,jk -&gt; ik&quot;</code>. Then the result of that is given as the first argument to <code>ein&quot;ik,kl -&gt; il&quot;</code> with the third argument as the second input.</p><p>To improve understanding, you might replace the integers with <code>getindex</code> operations in your head</p><pre><code class="language-julia hljs">ein&quot;(ij,jk),kl -&gt; il&quot;(xs...)
⇒ NestedEinsum{...}((NestedEinsum{...}((xs[1], xs[2]), ein&quot;ij,jk -&gt; ik&quot;), xs[3]), ein&quot;ik,kl -&gt; il&quot;)</code></pre><p>and finally turn it into</p><pre><code class="language-julia hljs">ein&quot;(ij,jk),kl -&gt; il&quot;(xs...)
⇒ ein&quot;ik,kl -&gt; il&quot;(ein&quot;ij,jk -&gt; ik&quot;(xs[1], xs[2]), xs[3])</code></pre></article><nav class="docs-footer"><a class="docs-footer-prevpage" href="../">« Home</a><a class="docs-footer-nextpage" href="../implementation/">Implementations »</a><div class="flexbox-break"></div><p class="footer-message">Powered by <a href="https://github.com/JuliaDocs/Documenter.jl">Documenter.jl</a> and the <a href="https://julialang.org/">Julia Programming Language</a>.</p></nav></div><div class="modal" id="documenter-settings"><div class="modal-background"></div><div class="modal-card"><header class="modal-card-head"><p class="modal-card-title">Settings</p><button class="delete"></button></header><section class="modal-card-body"><p><label class="label">Theme</label><div class="select"><select id="documenter-themepicker"><option value="documenter-light">documenter-light</option><option value="documenter-dark">documenter-dark</option></select></div></p><hr/><p>This document was generated with <a href="https://github.com/JuliaDocs/Documenter.jl">Documenter.jl</a> version 0.27.19 on <span class="colophon-date" title="Friday 10 June 2022 06:06">Friday 10 June 2022</span>. Using Julia version 1.7.3.</p></section><footer class="modal-card-foot"></footer></div></div></div></body></html>
